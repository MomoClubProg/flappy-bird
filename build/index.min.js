const isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);function jumpKey(){console.log("JUMP"),world.startScreen?(world.pause=!1,world.startScreen=!1,loop()):world.pause?(world.pause=!1,initGame(),loop()):(world.bird.jump(deltaTime),console.trace())}function keyPressed(){32===keyCode&&jumpKey()}function touchStarted(){if("touchstart"!=event.type)return!0;jumpKey()}function getUniqueID(){return"3834738478374"}class Stats{constructor(){let i=localStorage.getItem(`FlappyBirdSession${GAME_MODE}`);null===i?(this.user={name:getUniqueID()},this.platform=isMobile?"mobile":"desktop",this.score={current:0,high:0,attempts:0},this.settings={}):this.load(JSON.parse(i))}load(i){this.user=i.user,this.score=i.score,this.platform=isMobile?"mobile":"desktop"}renderMenu(){world.pause&&(noStroke(0),fill(0),textSize(72),textAlign(CENTER),text("Perdu!",wnx/2,wny/2),textSize(wnx/18),textAlign(CENTER),text("Appuyez pour recommencer",wnx/2,wny/2+wny/12))}newAttempt(){this.score.current=0,this.score.attempts++,localStorage.setItem(`FlappyBirdSession${GAME_MODE}`,JSON.stringify(this))}setHighScore(){this.score.high<this.score.current&&(this.score.high=this.score.current)}renderCounters(){noStroke(),world.pause?fill(0):fill(255),textSize(20),textAlign(LEFT),"normal"!==GAME_MODE&&text(`Mode ${World.TRANSLATION[GAME_MODE]}`,20,wny-20),text("Essais: "+this.score.attempts,20,30),text("Record: "+this.score.high,20,50),text("Score: "+this.score.current,20,70),this.setHighScore()}}class Background{constructor(i=4){this.imageLayers=[],this.backgroundWidth=isMobile?3840*wny/1080:3840,this.backgroundHeight=isMobile?wny:1080,this.ytranslate=[wny/6,-wny/6,isMobile?wny/6:0,isMobile?wny/6:-wny/32],this.xoffset=Array(i).fill(0);for(let t=0;t<i;t++)this.imageLayers.push(loadImage(`./assets/background/layer${t}.png`))}reset(){this.xoffset=Array(this.xoffset.length).fill(0)}update(i){this.xoffset=this.xoffset.map((t,s)=>((t-=(s+1)*.2*World.SETTINGS.SPEED*i)<=-this.backgroundWidth&&(t+=this.backgroundWidth),t))}render(){background(80,200,255);for(let i=0;i<this.imageLayers.length;i++)image(this.imageLayers[i],this.xoffset[i],i-10*i+this.ytranslate[i],this.backgroundWidth,this.backgroundHeight),image(this.imageLayers[i],this.xoffset[i]+this.backgroundWidth,i-10*i+this.ytranslate[i],this.backgroundWidth,this.backgroundHeight);push(),fill(0,0,0,100),rect(0,0,wnx,wny),pop()}}class World{constructor(i,t){this.background=t,this.gapSize=World.SETTINGS.GAP_SIZE,this.pipes=[],this.offsetFunc=isMobile?World.mobilePipeOffset:World.desktopPipeOffset,this.nearestPipeIndex=0;for(let s=0;s<i;s++){let e=this.offsetFunc(s,i);this.pipes.push(new Pipe(e,random(250,wny-250),this.gapSize))}this.pause=!1,this.pausedTick=0,this.startScreen=!0,this.bird=new Bird(wnx/(isMobile?3:2),wny/2),this.tick=0}static normal=new p5.Vector(1,0);static delay(i){return new Promise(t=>setTimeout(t,i))}static desktopPipeOffset(i,t){return i*wnx/t+(t-1)*wnx/t-28}static mobilePipeOffset(i,t){return i*(wnx/t)+wnx-26}static getGameMode(){let i=window.location.href.split("?")[1];if(void 0===i)return"normal";let t=i.split("&"),s;for(let e=0;e<t.length;e++){let r=t[e].split("=");"d"===r[0]&&(s=r[1])}return s||"normal"}reset(){this.background.reset(),this.startScreen=!1;let i=this.pipes.length;this.pipes=[],this.nearestPipeIndex=0;for(let t=0;t<i;t++){let s=this.offsetFunc(t,i);this.pipes.push(new Pipe(s,random(250,wny-250),this.gapSize))}this.pause=!1,this.pausedTick=0,this.bird=new Bird(wnx/(isMobile?3:2),wny/2),this.tick=0}incrementNearestPipe(){this.nearestPipeIndex<this.pipes.length-1?this.nearestPipeIndex++:this.nearestPipeIndex=0}updatePause(){this.pausedTick>200||(this.bird.size+=this.pausedTick,this.pausedTick+=4)}update(i){if(this.pause){this.updatePause();return}this.pausedTick=0,this.background.update(i),!this.startScreen&&(this.pipes.forEach(t=>{t.update(i)}),this.pipes[this.nearestPipeIndex].checkScore(this.bird),this.bird.update(i),this.bird.isOutOfBounds()&&this.endGame(),this.bird.isColliding(this.pipes[this.nearestPipeIndex])&&this.endGame(),this.tick++)}render(){if(this.background.render(),this.pipes.forEach(i=>{i.render()}),this.bird.render(),stats.renderCounters(),this.startScreen){let i=constrain(wnx/18,12,48);textSize(i),text("â–²  Tap to start!",this.bird.pos.x-i/2,this.bird.pos.y+1.8*i)}}async endGame(){this.bird.color.setAlpha(160),noLoop(),await World.delay(250),world.pause=!0,loop()}setGaps(i=120){this.gapSize=i,this.pipes.forEach(t=>{t.gapSize=i})}}const wnx=window.innerWidth,wny=window.innerHeight,GAME_MODE=World.getGameMode();World.SETTINGS=({dev:{SPEED:isMobile?.22:.27,GRAVITY:.05,FRICTION:.94,JUMP_HEIGHT:isMobile?.9:1.2,PIPE_WIDTH:isMobile?42:50,GAP_SIZE:wny/6.5,NOISE:!1,NOISE_SPEED:0},easy:{SPEED:isMobile?.18:.2,GRAVITY:.05,FRICTION:.94,JUMP_HEIGHT:isMobile?.9:1.2,PIPE_WIDTH:isMobile?38:50,GAP_SIZE:wny/5,NOISE:!1,NOISE_SPEED:0},normal:{SPEED:isMobile?.22:.29,GRAVITY:.05,FRICTION:.94,JUMP_HEIGHT:isMobile?1.1:1.6,PIPE_WIDTH:isMobile?44:54,GAP_SIZE:wny/5.8,NOISE:!1,NOISE_SPEED:0},hard:{SPEED:isMobile?.25:.3,GRAVITY:.05,FRICTION:.94,JUMP_HEIGHT:isMobile?.9:1.2,PIPE_WIDTH:isMobile?50:58,GAP_SIZE:wny/6.5,NOISE:!0,NOISE_SPEED:.0025}})[GAME_MODE],World.TRANSLATION={dev:"D\xe9velopement",easy:"Facile",normal:"",hard:"Difficile"};class Pipe{constructor(i,t,s){this.x=i,this.y=t,this.gapSize=s,this.width=World.SETTINGS.PIPE_WIDTH,this.speed=World.SETTINGS.SPEED,this.collisionRange=3,this.ran=random(0,1e4)}render(){noStroke(),fill(200),rect(this.x,this.y,this.width,wny-this.y),rect(this.x,0,this.width,this.y-this.gapSize)}checkScore(i){let t=this.x+this.width-i.pos.x;t<=this.collisionRange&&t>=-this.collisionRange&&(stats.score.current++,world.incrementNearestPipe())}update(i){this.x<=-this.width?(this.x=wnx,this.y=random(wny/3.5,wny-wny/3.5)):this.x=this.x-this.speed*i,this.speed+=625e-7,this.collisionRange+=625e-7*i,World.SETTINGS.NOISE&&(this.y=wny/2*noise(world.tick*World.SETTINGS.NOISE_SPEED+this.ran)+wny/4)}isColliding(i){return wnx/2>this.x-3&&wnx/2<this.x+this.width+3&&(i.y<this.y-this.gapSize+3||i.y>this.y-3)}}class Bird{constructor(i,t){this.vy=0,this.ay=0,this.pos=createVector(i,t),this.dir=createVector(1,0),this.color=color(255,255),this.size=18,this.jumpThreshold=0}isColliding(i){return this.pos.x>i.x-9&&this.pos.x<i.x+i.width+11&&(this.pos.y<i.y-i.gapSize+11||this.pos.y>i.y-11)}render(){noStroke(),fill(this.color),circle(this.pos.x,this.pos.y,this.size),world.pause||(strokeWeight(3),stroke(255,180,35),line(this.pos.x,this.pos.y,this.pos.x+this.dir.x*((this.size-2)/2),this.pos.y+this.dir.y*((this.size-2)/2)))}isOutOfBounds(){return this.pos.y<=0||this.pos.y>=wny}getAngle=()=>World.normal.angleBetween(this.dir);update(i){this.ay-=World.SETTINGS.GRAVITY,this.vy-=this.ay,this.vy<-World.SETTINGS.JUMP_HEIGHT&&(this.vy=-World.SETTINGS.JUMP_HEIGHT),this.getAngle()<HALF_PI&&this.dir.rotate(.003125*i),this.pos.y=this.pos.y+this.vy*i,this.vy*=World.SETTINGS.FRICTION,this.ay*=0,this.jumpThreshold++}jump(i){this.jumpThreshold>.5*i&&(this.jumpThreshold=0,this.ay=World.SETTINGS.JUMP_HEIGHT,this.getAngle()&&(this.dir.x=.35,this.dir.y=-.65,this.dir.normalize()))}}let world,DT;function preload(){refVector=createVector(1,0),stats=new Stats}function setup(){let i=new Background;world=new World(isMobile?2:5,i),createCanvas(wnx,wny),frameRate(80)}function initGame(){stats.newAttempt(),world.reset()}function draw(){world.update(deltaTime),world.render(),stats.renderMenu()}